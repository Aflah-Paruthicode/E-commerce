<%- include('../layouts/header.ejs') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/userCss/cart.css" />

<div class="container cart-wrapper" style="min-height: 70vh;">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="cart-card">
        <div class="p-4 border-bottom d-flex justify-content-between align-items-center">
          <h4 class="fw-bold m-0">Your Bag</h4>
          <span class="badge bg-dark rounded-pill"><%= products.length %> Items</span>
        </div>

        <form action="/cartCheckout" method="post" id="subbForm">
          <% let ogTotel=0; let k=1; let z=0; %> <% products.forEach((product) => { %> <% let quantity = (typeof productQuantitys !== 'undefined') ?
          productQuantitys[z] : 1; %>

          <div class="cart-item">
            <div class="product-img-container">
              <img src="/productImages/<%= product.images[0] %>" class="product-img" alt="" />
              <% if (product.quantity < 1) { %>
              <div class="out-of-stock-overlay">Out of Stock</div>
              <% } %>
            </div>

            <div class="ms-4 flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="fw-bold mb-1"><%= product.name.length > 40 ? product.name.slice(0, 40) + '...' : product.name %></h5>
                  <p class="text-muted small mb-2"><%= product.category %></p>
                </div>
                <button type="button" class="btn-close small" onclick="confirmDelete(event, '<%= product._id %>')"></button>
              </div>

              <% ogTotel += product.og_price; let today = new Date(); let hasOffer = false; let discountPerc = 0; let finalPrice = product.price;
              if((product.product_OfferDetails && product.product_OfferDetails.offerStartDate <= today && product.product_OfferDetails.offerEndDate >= today)) {
              hasOffer = true; discountPerc = product.product_OfferDetails.discountPercentage; finalPrice = product.price - (product.price * discountPerc /
              100); } else if (product.category_OfferDetails && product.category_OfferDetails.offerStartDate <= today &&
              product.category_OfferDetails.offerEndDate >= today) { hasOffer = true; discountPerc = product.category_OfferDetails.discountPercentage;
              finalPrice = product.price - (product.price * discountPerc / 100); } %>

              <div class="d-flex align-items-center gap-2 mb-3">
                <span class="price-final">₹<%= finalPrice.toFixed(0) %></span>
                <% if(hasOffer) { %>
                <span class="price-og">₹<%= product.price %></span>
                <span class="offer-tag"><%= discountPerc %>% OFF</span>
                <% } %>
              </div>

              <div class="d-flex align-items-center">
                <label class="small fw-bold text-muted me-3">QTY:</label>
                <% if (product.quantity > 0) { %>
                <div class="qty-control">
                  <div class="qty-btn" onclick="changeQuantity(-1, <%= k %>)">-</div>
                  <input type="text" id="quantity-input<%= k %>" name="quantityOf<%= k %>" class="qty-input" value="<%= quantity %>" readonly />
                  <div class="qty-btn" onclick="changeQuantity(1, <%= k %>)">+</div>
                </div>
                <% } else { %>
                <span class="text-danger small fw-bold">Unavailable</span>
                <% } %>
              </div>
            </div>
          </div>
          <% k++; z++; }) %> <% if(products.length > 0) { %>
          <div class="p-4 bg-light text-end">
            <input type="submit" class="btn btn-dark btn-lg px-5 fw-bold" value="Proceed to Checkout" style="border-radius: 10px" />
          </div>
          <% } else { %>
            <div class="p-4 bg-light text-end">
            <p class="px-5 fw-bold" style="border-radius: 10px" > Cart is empty! </p>
          </div>
         <%  } %>
        </form>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="summary-card">
        <h5 class="fw-bold mb-4">Order Summary</h5>

        <div class="summary-row">
          <span>Items Total</span>
          <span>₹<%= sum %>.00</span>
        </div>

        <% let delCharge = 50 * products.length; %>
        <div class="summary-row">
          <span>Delivery Fee</span>
          <span>₹<%= delCharge %>.00</span>
        </div>

        <% let gst = Math.floor(sum / 10); %>
        <div class="summary-row">
          <span>Estimated GST (10%)</span>
          <span>₹<%= gst %>.00</span>
        </div>

        <div class="summary-total">
          <div>
            <h6 class="fw-bold m-0">Total Amount</h6>
            <small class="text-success fw-bold">You save ₹<%= (ogTotel - sum).toFixed(0) %></small>
          </div>
          <h4 class="fw-bold text-dark">₹<%= (sum + gst + delCharge) %>.00</h4>
        </div>

        <div class="mt-4">
          <% if(products.length > 0) { %>
          <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Promo code" id="couponInput" />
            <button class="btn btn-outline-dark" type="button">Apply</button>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/footer.ejs') %>

<script>
  function confirmDelete(event, productId) {
    event.preventDefault();
    Swal.fire({
      title: "Remove item?",
      text: "This product will be removed from your cart.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#000",
      cancelButtonColor: "#d33",
      confirmButtonText: "Remove",
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "/RemovePdtFrmCart/" + productId;
      }
    });
  }

  function changeQuantity(change, which) {
    const input = document.getElementById("quantity-input" + which);
    let currentQuantity = parseInt(input.value);
    currentQuantity += change;

    if (currentQuantity < 1) currentQuantity = 1;
    if (currentQuantity > 10) currentQuantity = 10;

    input.value = currentQuantity;

    const form = document.getElementById("subbForm");
    form.action = "/updateCartQuantity";
    form.submit();
  }
</script>
