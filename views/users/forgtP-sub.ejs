<%- include('../layouts/header.ejs') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" href="/css/userCss/forgotPaOtp.css" />

<div class="recovery-wrapper">
  <div class="recovery-card">
    <div class="mb-3">
      <i class="fa-solid fa-shield-halved fa-3x" style="color: #000"></i>
    </div>
    <h2>Password Recovery</h2>
    <p>We've sent a 6-digit security code to your email. Please verify to reset your password.</p>

    <form id="otpForm">
      <input type="hidden" name="sec" id="sec_hidden" />
      <input type="hidden" id="hidden-otp" name="hiddenOtp" />

      <div class="otp-group" id="inputs">
        <% for(let i=0; i<6; i++) { %>
        <input class="otp-field" type="text" inputmode="numeric" maxlength="1" autocomplete="one-time-code" />
        <% } %>
      </div>

      <div class="timer-container">
        <span id="timer-display">02:00</span>
        <a href="javascript:void(0)" id="resendBtn" class="resend-btn" onclick="location.reload()">
          <i class="fa-solid fa-rotate-right me-1"></i> Resend OTP
        </a>
      </div>

      <button type="submit" class="btn-submit" id="subbu">Reset Password</button>
      <p id="errorMsg" class="error-text"></p>
    </form>
  </div>
</div>

<script>
  const fields = document.querySelectorAll(".otp-field");
  const hiddenInput = document.getElementById("hidden-otp");
  const errorMsg = document.getElementById("errorMsg");

  fields.forEach((field, index) => {
    field.addEventListener("input", (e) => {
      const value = e.target.value;
      if (isNaN(value)) {
        e.target.value = "";
        return;
      }
      if (value && index < fields.length - 1) {
        fields[index + 1].focus();
      }
      updateOTPValue();
    });

    field.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !e.target.value && index > 0) {
        fields[index - 1].focus();
      }
    });
  });

  function updateOTPValue() {
    let code = "";
    fields.forEach((f) => (code += f.value));
    hiddenInput.value = code;
  }

  let totalSeconds = 120;
  const timerDisplay = document.getElementById("timer-display");
  const resendBtn = document.getElementById("resendBtn");
  const secHidden = document.getElementById("sec_hidden");

  const countdown = setInterval(() => {
    totalSeconds--;
    let mins = Math.floor(totalSeconds / 60);
    let secs = totalSeconds % 60;

    timerDisplay.textContent = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    secHidden.value = totalSeconds;

    if (totalSeconds <= 0) {
      clearInterval(countdown);
      timerDisplay.style.display = "none";
      resendBtn.style.display = "inline-block";
    }
  }, 1000);

  document.getElementById("otpForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    errorMsg.textContent = "";

    const otpValue = hiddenInput.value;
    if (otpValue.length < 6) {
      errorMsg.textContent = "Please enter all 6 digits.";
      return;
    }

    try {
      const response = await fetch("submitFpOtpPage?id=<%= id %>", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hiddenOtp: otpValue, sec: totalSeconds }),
      });

      const result = await response.json();

      if (result.success) {
        window.location.href = "/loadSetNPage?id=<%= id %>";
      } else {
        errorMsg.textContent = result.emessage || "Verification failed. Try again.";
        fields.forEach((f) => (f.value = ""));
        fields[0].focus();
      }
    } catch (err) {
      console.error("Submission error:", err);
      errorMsg.textContent = "Server error. Please check your connection.";
    }
  });
</script>

<%- include('../layouts/footer.ejs') %>
