<%- include('../layouts/header.ejs') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  

<link rel="stylesheet" href="/css/userCss/otp.css">

<div class="otp-wrapper">
  <div class="otp-card">
    <h2>Verify Account</h2>
    <p>Enter the 6-digit code sent to your device.</p>

    <form id="otpForm">
      <input type="hidden" name="sec" id="sec_hidden" />
      <input type="hidden" id="hidden-otp" name="hiddenOtp" />

      <div class="otp-input-group" id="inputs">
        <% for(let i=0; i<6; i++) { %>
        <input class="otp-field" type="text" inputmode="numeric" maxlength="1" />
        <% } %>
      </div>

      <div class="mb-4">
        <span id="timer-display" class="timer-text">02:00</span>
        <a href="javascript:void(0)" id="resendBtn" class="resend-link" onclick="location.reload()">Resend Code</a>
      </div>

      <button type="submit" class="btn-verify">Verify & Proceed</button>
    </form>
  </div>
</div>

<script>
  const fields = document.querySelectorAll(".otp-field");
  const hiddenInput = document.getElementById("hidden-otp");

  fields.forEach((field, index) => {
    field.addEventListener("input", (e) => {
      if (e.target.value.length > 0 && index < fields.length - 1) {
        fields[index + 1].focus();
      }
      updateOTPValue();
    });

    field.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && e.target.value.length === 0 && index > 0) {
        fields[index - 1].focus();
      }
    });
  });

  function updateOTPValue() {
    let code = "";
    fields.forEach((f) => (code += f.value));
    hiddenInput.value = code;
  }

  let totalSeconds = 120;
  const timerDisplay = document.getElementById("timer-display");
  const resendBtn = document.getElementById("resendBtn");
  const secHidden = document.getElementById("sec_hidden");

  const countdown = setInterval(() => {
    totalSeconds--;

    let mins = Math.floor(totalSeconds / 60);
    let secs = totalSeconds % 60;

    timerDisplay.textContent = `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
    secHidden.value = totalSeconds;

    if (totalSeconds <= 0) {
      clearInterval(countdown);
      timerDisplay.style.display = "none";
      resendBtn.style.display = "inline-block";
    }
  }, 1000);

  document.getElementById("otpForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const otpValue = hiddenInput.value;
    if (otpValue.length < 6) {
      return Swal.fire("Wait!", "Please enter the full 6-digit code.", "warning");
    }

    const data = { hiddenOtp: otpValue, sec: totalSeconds };

    fetch("/otpSubmit?id=<%= user._id %>", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    })
      .then((res) => res.json())
      .then((response) => {
        if (response.success) {
          location.href = "/";
        } else {
          Swal.fire("Failed!", response.emessage || "Invalid OTP", "error");
        }
      })
      .catch((err) => {
        console.error(err);
        Swal.fire("Error", "Server connection lost.", "error");
      });
  });
</script>

<%- include('../layouts/footer.ejs') %>
