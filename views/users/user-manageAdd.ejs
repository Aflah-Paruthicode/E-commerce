<%- include('../layouts/header.ejs') %>
<link rel="stylesheet" href="/css/userCss/userProffile.css" />  

<link rel="stylesheet" href="/css/userCss/manageAdd.css">

<div class="profile-wrapper">
  <aside class="profile-sidebar">
    <div class="user-greeting">
      <img src="/userProfileImages/user (1).png" alt="User" />
      <div>
        <small class="text-muted">Hello,</small>
        <h2><%= user.name %></h2>
      </div>
    </div>

    <nav class="nav-menu">
      <a href="/profile" class="nav-item-link"> <i class="fa-solid fa-gauge"></i> Account Overview </a>
      <a href="/myOrders" class="nav-item-link"> <i class="fa-solid fa-box"></i> My Orders </a>
      <a href="/manageAddress" class="nav-item-link active"> <i class="fa-solid fa-map-location-dot"></i> Manage Addresses </a>
      <a href="/whishlist" class="nav-item-link"> <i class="fa-solid fa-heart"></i> My Wishlist </a>
      <a href="/wallet" class="nav-item-link"> <i class="fa-solid fa-wallet"></i> Wallet </a>
      <a href="/logout" class="nav-item-link text-danger"> <i class="fa-solid fa-right-from-bracket"></i> Logout </a>
    </nav>
  </aside>

  <main class="profile-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold m-0">Manage Address</h3>
    </div>

    <main class="profile-content" style="border: none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/addAddress" class="btn btn-dark px-4 py-2"> <i class="fa-solid fa-plus me-2"></i> Add New Address </a>
      </div>

      <div class="address-grid">
        <% if (address.length === 0) { %>
        <div class="text-center py-5 w-100">
          <img src="/userProfileImages/location.png" width="80" class="mb-3 opacity-25" />
          <p class="text-muted">No addresses saved yet.</p>
        </div>
        <% } %> <% address.forEach((addrss) => { %>
        <div class="address-card-modern <%= addrss.isSelected ? 'selected' : '' %>">
          <% if(addrss.isSelected) { %>
          <div class="default-badge">DEFAULT</div>
          <% } %>

          <div class="address-card-header">
            <div class="address-type-icon">
              <i class="fa-solid <%= addrss.isSelected ? 'fa-location-dot' : 'fa-map-pin' %>"></i>
            </div>
            <div class="address-actions">
              <a href="/EditAddress?id=<%= addrss._id %>" title="Edit"><i class="fa-solid fa-pen-to-square"></i></a>
              <a href="javascript:void(0)" onclick="confirmDelete(event, '<%= addrss._id %>')" title="Delete" class="text-danger"
                ><i class="fa-solid fa-trash-can"></i
              ></a>
            </div>
          </div>

          <div class="address-body">
            <h5 class="customer-name"><%= user.name %></h5>
            <p class="address-details">
              <%= addrss.houseName %>, <%= addrss.street %><br />
              <%= addrss.city %>, <%= addrss.state %><br />
              <strong>PIN: <%= addrss.pincode %></strong>
            </p>
            <p class="phone-number"><i class="fa-solid fa-phone me-2"></i> <%= addrss.mobile || user.mobile %></p>
          </div>

          <div class="address-footer">
            <% let selectUrl = (typeof from !== 'undefined') ? `/selectAddress?id=${addrss._id}&from=${from}` :
            `/selectAddress?id=${addrss._id}&from=userManagement` %> <% if(addrss.isSelected) { %>
            <button class="btn-selected w-100" disabled><i class="fa-solid fa-circle-check"></i> Primary Address</button>
            <% } else { %>
            <a href="<%= selectUrl %>" class="btn-select-address w-100">Set as Primary</a>
            <% } %>
          </div>
        </div>
        <% }) %>
      </div>
    </main>
  </main>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  function confirmDelete(event, productId) {
    event.preventDefault();
    Swal.fire({
      title: "Are you sure?",
      text: "You want to cancel this order!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#000",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, cancel it!",
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "/cancelOrder/" + productId;
      }
    });
  }

  $(document).ready(function () {
    $(".retry-payment").click(function () {
      var orderId = $(this).data("order-id");
      $.ajax({
        url: "/confirmRetryOrder",
        method: "POST",
        data: { id: orderId },
        success: function (res) {
          if (res.success) {
            var options = {
              key: res.key_id,
              amount: res.amount,
              currency: "INR",
              name: "Dash Footwares",
              order_id: res.order_id,
              handler: function (response) {
                window.location.href = "/updateOrderInDb/?id=" + orderId;
              },
              theme: { color: "#000000" },
            };
            var rzp = new Razorpay(options);
            rzp.open();
          } else {
            alert(res.msg);
          }
        },
      });
    });
  });
</script>

<%- include('../layouts/footer.ejs') %>
