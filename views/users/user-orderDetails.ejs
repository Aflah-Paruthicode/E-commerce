<%- include('../layouts/header.ejs') %>
<link rel="stylesheet" href="/css/userCss/userProffile.css" />

<link rel="stylesheet" href="css/userCss/orderDetails.css" />

<div class="profile-wrapper">
  <aside class="profile-sidebar">
    <div class="user-greeting">
      <img src="/userProfileImages/user (1).png" alt="User" />
      <div>
        <small class="text-muted">Hello,</small>
        <h2><%= user.name %></h2>
      </div>
    </div>

    <nav class="nav-menu">
      <a href="/profile" class="nav-item-link active"> <i class="fa-solid fa-gauge"></i> Account Overview </a>
      <a href="/myOrders" class="nav-item-link"> <i class="fa-solid fa-box"></i> My Orders </a>
      <a href="/manageAddress" class="nav-item-link"> <i class="fa-solid fa-map-location-dot"></i> Manage Addresses </a>
      <a href="/whishlist" class="nav-item-link"> <i class="fa-solid fa-heart"></i> My Wishlist </a>
      <a href="/wallet" class="nav-item-link"> <i class="fa-solid fa-wallet"></i> Wallet </a>
      <a href="/logout" class="nav-item-link text-danger"> <i class="fa-solid fa-right-from-bracket"></i> Logout </a>
    </nav>
  </aside>
  <main class="profile-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center">
        <a href="/myOrders" class="btn-back-round me-3"><i class="fa-solid fa-arrow-left"></i></a>
        <h3 class="fw-bold m-0">Order Details</h3>
      </div>
      <div class="d-flex gap-2">
        <% if(order.status == 'Delivered') { %>
        <button class="btn btn-outline-warning btn-sm px-3" onclick="returnButton('<%= order._id %>')">
          <i class="fa-solid fa-rotate-left me-1"></i> Return
        </button>
        <% } %>
        <a href="/downloadOrderInvoice/?orderId=<%= order._id %>" class="btn btn-info btn-sm px-3 text-white">
          <i class="fa-solid fa-file-invoice me-1"></i> Invoice
        </a>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="order-card-premium mb-4">
          <div class="status-banner <%= order.status.toLowerCase().replace(' ', '-') %>">
            <i class="fa-solid fa-circle-dot me-2"></i> Current Status: <strong><%= order.status %></strong>
          </div>

          <div class="p-4">
            <div class="d-flex gap-4 align-items-start">
              <div class="product-img-wrapper">
                <img src="/productImages/<%= product.images[0] %>" alt="Product" />
              </div>
              <div class="flex-grow-1">
                <span class="text-muted small">Order ID: #<%= order._id %></span>
                <h4 class="fw-bold mt-1"><%= product.name %></h4>
                <p class="mb-2">Quantity: <strong><%= order.quantity %></strong></p>

                <div class="price-pill mt-3">
                  <% if(order.product_OfferDetails || order.category_OfferDetails) { const disc = order.product_OfferDetails ?
                  order.product_OfferDetails.discountPercentage : order.category_OfferDetails.discountPercentage; const finalPrice = product.price -
                  (product.price * disc / 100); %>
                  <span class="final-price">₹<%= finalPrice.toFixed(2) %></span>
                  <span class="original-price"><del>₹<%= product.price %></del></span>
                  <span class="discount-badge"><%= disc %>% OFF</span>
                  <% } else { %>
                  <span class="final-price">₹<%= product.price %>.00</span>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="order-card-premium p-4 mb-4">
          <h6 class="fw-bold mb-3 text-uppercase small opacity-75">Shipping & Payment</h6>
          <div class="row">
            <div class="col-md-6 border-end">
              <p class="mb-1 text-muted small">Delivery Address</p>
              <p class="fw-500 mb-0"><%= user.address %></p>
            </div>
            <div class="col-md-6 ps-md-4">
              <p class="mb-1 text-muted small">Payment Method</p>
              <p class="fw-500 mb-0"><i class="fa-solid fa-credit-card me-2"></i><%= order.paymentMethod %></p>
              <p class="mb-0 text-muted small mt-2">Placed on: <%= order.date %></p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="order-card-premium p-4 sticky-top" style="top: 20px">
          <h5 class="fw-bold mb-4">Order Summary</h5>

          <div class="summary-row">
            <span>Subtotal</span>
            <span>₹<%= (product.price * order.quantity).toFixed(2) %></span>
          </div>

          <% if(order.coupon_applied !== 'no') { %>
          <div class="summary-row text-success">
            <span>Coupon (<%= order.coupon_applied %>)</span>
            <span>-₹<%= (order.coupon_Discount || 0).toFixed(2) %></span>
          </div>
          <% } %>

          <div class="summary-row">
            <span>GST (Tax)</span>
            <span>+₹<%= taxAmount %>.00</span>
          </div>

          <div class="summary-row">
            <span>Shipping</span>
            <span><%= order.deliveryChaerge > 0 ? '₹' + order.deliveryChaerge : 'FREE' %></span>
          </div>

          <hr class="my-3 opacity-10" />

          <div class="summary-row total">
            <span>Grand Total</span>
            <span class="text-dark">₹<%= order.totelAmmount %>.00</span>
          </div>

          <div class="alert alert-light border-0 small mt-4 mb-0">
            <i class="fa-solid fa-shield-check me-2 text-success"></i>
            This order is covered by DashFootwares protection.
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
