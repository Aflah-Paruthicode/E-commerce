<%- include('../layouts/header.ejs') %>
<link rel="stylesheet" href="/css/userCss/userProffile.css" />
<link rel="stylesheet" href="/css/userCss/orders.css" />

<style></style>

<div class="profile-wrapper">
  <aside class="profile-sidebar">
    <div class="user-greeting">
      <img src="/userProfileImages/user (1).png" alt="User" />
      <div>
        <small class="text-muted">Hello,</small>
        <h2><%= user.name %></h2>
      </div>
    </div>

    <nav class="nav-menu">
      <a href="/profile" class="nav-item-link"> <i class="fa-solid fa-gauge"></i> Account Overview </a>
      <a href="/myOrders" class="nav-item-link active"> <i class="fa-solid fa-box"></i> My Orders </a>
      <a href="/manageAddress" class="nav-item-link"> <i class="fa-solid fa-map-location-dot"></i> Manage Addresses </a>
      <a href="/whishlist" class="nav-item-link"> <i class="fa-solid fa-heart"></i> My Wishlist </a>
      <a href="/wallet" class="nav-item-link"> <i class="fa-solid fa-wallet"></i> Wallet </a>
      <a href="/logout" class="nav-item-link text-danger"> <i class="fa-solid fa-right-from-bracket"></i> Logout </a>
    </nav>
  </aside>

  <main class="profile-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold m-0">My Orders</h3>
      <span class="badge bg-dark px-3 py-2"><%= products.length %> Total Items</span>
    </div>

    <div class="orders-list-container">
      <% if(products.length === 0) { %>
      <div class="empty-state">
        <div class="empty-icon-circle">
          <i class="fa-solid fa-box-open"></i>
        </div>
        <h4>No orders yet</h4>
        <p class="text-muted">When you buy something, it will appear here.</p>
        <a href="/shop" class="btn btn-dark mt-3 px-4">Start Shopping</a>
      </div>
      <% } %> <% products.forEach((product, i) => { %>
      <div class="order-card-premium">
        <div class="order-card-top">
          <div class="order-meta">
            <span class="order-id-label">ORDER #<%= order[i]._id.toString().slice(-8).toUpperCase() %></span>
            <span class="order-separator">|</span>
            <span class="order-date"><%= order[i].date %></span>
          </div>
          <div class="order-total-badge"><span>Total: </span><strong>â‚¹<%= order[i].totelAmmount %></strong></div>
        </div>

        <div class="order-card-content">
          <div class="product-info-section">
            <div class="product-img-wrapper">
              <img src="/productImages/<%= product.images[0] %>" alt="Product" />
            </div>
            <div class="product-details">
              <h5 class="product-title"><%= product.name %></h5>
              <div class="product-subtext">
                <span>Qty: <strong><%= order[i].quantity %></strong></span>
                <span class="dot-spacer"></span>
                <span>Method: <strong><%= order[i].paymentMethod %></strong></span>
              </div>
            </div>
          </div>

          <div class="status-action-section">
            <div class="status-indicator">
              <% let statusClass = 'status-default'; if(order[i].status === 'Delivered') statusClass = 'status-success'; if(order[i].status === 'Cancelled')
              statusClass = 'status-error'; if(order[i].status === 'Pending') statusClass = 'status-warn'; if(order[i].status === 'Shipped') statusClass =
              'status-info'; %>
              <span class="status-dot <%= statusClass %>"></span>
              <span class="status-text <%= statusClass %>-text"><%= order[i].status %></span>
            </div>

            <div class="action-buttons">
              <a href="/orderDetails/?orderId=<%= order[i]._id %>" class="btn-action view-btn"> <i class="fa-solid fa-eye"></i> View </a>

              <% if(order[i].status === 'Pending') { %>
              <button class="btn-action retry-btn retry-payment" data-order-id="<%= order[i]._id %>"><i class="fa-solid fa-rotate-right"></i> Retry</button>
              <% } else if(!['Cancelled', 'Delivered', 'Shipped'].includes(order[i].status)) { %>
              <button onclick="confirmDelete(event, '?id=<%= order[i]._id %>&quantity=<%= order[i].quantity %>');" class="btn-action cancel-btn">
                <i class="fa-solid fa-xmark"></i> Cancel
              </button>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

    <% if (pagination.totalPages > 1) { %>
    <div class="d-flex justify-content-center mt-4">
      <nav>
        <ul class="pagination pagination-sm">
          <% for (let j = 1; j <= pagination.totalPages; j++) { %>
          <li class="page-item <%= pagination.currentPage === j ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= j %>"><%= j %></a>
          </li>
          <% } %>
        </ul>
      </nav>
    </div>
    <% } %>
  </main>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  function confirmDelete(event, productId) {
    event.preventDefault();
    Swal.fire({
      title: "Are you sure?",
      text: "You want to cancel this order!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#000",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, cancel it!",
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "/cancelOrder/" + productId;
      }
    });
  }

  $(document).ready(function () {
    $(".retry-payment").click(function () {
      var orderId = $(this).data("order-id");
      $.ajax({
        url: "/confirmRetryOrder",
        method: "POST",
        data: { id: orderId },
        success: function (res) {
          if (res.success) {
            var options = {
              key: res.key_id,
              amount: res.amount,
              currency: "INR",
              name: "Dash Footwares",
              order_id: res.order_id,
              handler: function (response) {
                window.location.href = "/updateOrderInDb/?id=" + orderId;
              },
              theme: { color: "#000000" },
            };
            var rzp = new Razorpay(options);
            rzp.open();
          } else {
            alert(res.msg);
          }
        },
      });
    });
  });
</script>

<%- include('../layouts/footer.ejs') %>
