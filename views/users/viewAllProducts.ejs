<%- include('../layouts/header.ejs') %>  
<link rel="stylesheet" href="/css/userCss/viewAllProduct.css">


<div class="search-section">
    <div class="search-wrapper">
        <form action="/search" method="post" id="formofsearch">
            <input class="search-input-new" id="searchInputField" type="text" name="search" 
                   placeholder="What are you looking for today?" 
                   value="<%= typeof searchData !== 'undefined' ? searchData : '' %>">
        </form>
    </div>
</div>

<div class="catalog-container">
    <aside class="filter-sidebar">
        <div class="filter-group">
            <h5>Brands</h5>
            <% const brands = ['Puma', 'Adidas', 'New Balance', 'Nike']; %>
            <label class="filter-option">
                <input type="checkbox" <%= (typeof filteredAs === 'undefined' || filteredAs === 'all') ? 'checked' : '' %> 
                       onchange="filterNow('all')"> All Products
            </label>
            <% brands.forEach(brand => { %>
                <label class="filter-option">
                    <input type="checkbox" <%= (typeof filteredAs !== 'undefined' && filteredAs === brand) ? 'checked' : '' %> 
                           onchange="filterNow('<%= brand %>')"> <%= brand %>
                </label>
            <% }) %>
        </div>

        <div class="filter-group">
            <h5>Price Range</h5>
            <% const prices = [
                {label: 'Under ₹999', val: 'under rs 999'},
                {label: '₹1000 - ₹2999', val: 'rs 1000 to rs 2999'},
                {label: '₹3000 - ₹5000', val: 'rs 3000 to rs 5000'},
                {label: 'Above ₹5000', val: 'rs 5000 to rs 10000'}
            ]; %>
            <% prices.forEach(p => { %>
                <label class="filter-option">
                    <input type="checkbox" <%= (typeof pricefilteredAs !== 'undefined' && pricefilteredAs === p.val) ? 'checked' : '' %> 
                           onchange="priceFilterNow('<%= p.val %>')"> <%= p.label %>
                </label>
            <% }) %>
        </div>
    </aside>

    <main>
        <div class="sort-bar">
            <span class="text-muted"><%= products.length %> Products found</span>
            <div style="width: 200px;">
                <select class="form-select form-select-sm" onchange="loadSorted(this.value)">
                    <option value="">Sort By: Default</option>
                    <option value="Price Low To High" <%= (typeof sortedAs !== 'undefined' && sortedAs === 'Price Low To High') ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="Price High To Low" <%= (typeof sortedAs !== 'undefined' && sortedAs === 'Price High To Low') ? 'selected' : '' %>>Price: High to Low</option>
                    <option value="A to Z" <%= (typeof sortedAs !== 'undefined' && sortedAs === 'A to Z') ? 'selected' : '' %>>Name: A-Z</option>
                </select>
            </div>
        </div>

        <div class="product-list-wrapper">
            <% if (products && products.length > 0) { %>
                <% products.forEach((product) => { %>
                    <div class="product-row-card">
                        <a href="/viewProduct/?id=<%= product._id %>" class="img-holder">
                            <img src="/productImages/<%= product.images[0] %>" alt="<%= product.name %>">
                        </a>

                        <div class="details-holder">
                            <span class="brand-label"><%= product.company %></span>
                            <a href="/viewProduct/?id=<%= product._id %>" style="text-decoration:none; color:inherit;">
                                <h2><%= product.name.length > 40 ? product.name.slice(0, 38) + '...' : product.name %></h2>
                            </a>
                            <div class="mb-2 text-warning">
                                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i>
                            </div>
                            <p><%= product.product_desc %></p>
                        </div>

                        <div class="action-holder">
                            <% 
                                let today = new Date();
                                let finalPrice = product.price;
                                let isOffer = false;
                                let discount = 0;

                                if((product.product_OfferDetails && product.product_OfferDetails.offerStartDate <= today && product.product_OfferDetails.offerEndDate >= today) || 
                                   (product.category_OfferDetails && product.category_OfferDetails.offerStartDate <= today && product.category_OfferDetails.offerEndDate >= today)) {
                                    isOffer = true;
                                    discount = product.product_OfferDetails ? product.product_OfferDetails.discountPercentage : product.category_OfferDetails.discountPercentage;
                                    finalPrice = product.price - (product.price * discount / 100);
                                }
                            %>

                            <% if(isOffer) { %>
                                <span class="old-price">₹<%= product.price %></span>
                                <span class="price-big">₹<%= finalPrice.toFixed(0) %></span>
                                <span class="badge bg-success" style="font-size:10px;"><%= discount %>% OFF</span>
                            <% } else { %>
                                <span class="price-big">₹<%= product.price %></span>
                            <% } %>

                            <% if(product.quantity < 1) { %>
                                <span class="out-of-stock-text">OUT OF STOCK</span>
                            <% } else { %>
                                <a href="/addToCart/?id=<%= product._id %>" class="btn-action">ADD TO CART</a>
                            <% } %>
                            
                            <a href="/addToWhishlist/?id=<%= product._id %>&from=home" class="btn-wishlist">
                                <i class="fa-regular fa-heart"></i> Save for later
                            </a>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="text-center py-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/6134/6134065.png" width="100" class="mb-3" style="opacity: 0.2;">
                    <h3>No products found matching your criteria.</h3>
                </div>
            <% } %>
        </div>

        <% if (pagination.totalPages > 1) { %>
            <div class="pagination-container">
                <% if (pagination.hasPrevPage) { %>
                    <a class="page-link-custom" href="?page=<%= pagination.currentPage - 1 %>&limit=<%= pagination.limit %><%= queryString %>">Prev</a>
                <% } %>
                <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                    <a href="?page=<%= i %>&limit=<%= pagination.limit %><%= queryString %>" 
                       class="page-link-custom <%= pagination.currentPage === i ? 'active' : '' %>"><%= i %></a>
                <% } %>
                <% if (pagination.hasNextPage) { %>
                    <a class="page-link-custom" href="?page=<%= pagination.currentPage + 1 %>&limit=<%= pagination.limit %><%= queryString %>">Next</a>
                <% } %>
            </div>
        <% } %>
    </main>
</div>

<script>
  function updateURLParameter(url, param, paramVal) {
    let newAdditionalURL = "";
    let tempArray = url.split("?");
    let baseURL = tempArray[0];
    let additionalURL = tempArray[1];
    let temp = "";

    if (additionalURL) {
      tempArray = additionalURL.split("&");
      for (let i = 0; i < tempArray.length; i++) {
        if (tempArray[i].split("=")[0] !== param) {
          newAdditionalURL += temp + tempArray[i];
          temp = "&";
        }
      }
    }

    const rows_txt = temp + "" + param + "=" + paramVal;
    return baseURL + "?" + newAdditionalURL + rows_txt;
  }

  function priceFilterNow(value) {
    window.location.href = updateURLParameter(window.location.href, "Pricefiltered", value);
  }
  function filterNow(value) {
    window.location.href = updateURLParameter(window.location.href, "filtered", value);
  }
  function loadSorted(value) {
    window.location.href = updateURLParameter(window.location.href, "sorted", value);
  }

  let timeout = null;
  document.getElementById("searchInputField").addEventListener("keyup", function () {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      window.location.href = updateURLParameter(window.location.href, "searchData", this.value);
    }, 800);
  });
</script>
