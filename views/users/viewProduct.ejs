<%- include('../layouts/header.ejs') %>

<link rel="stylesheet" href="/css/userCss/viewProduct.css" />

<div class="container">
  <div class="product-nav-info">Home / <%= produCt.company %> / <span style="color: #111"><%= produCt.name %></span></div>

  <div class="view-product-container">
    <div class="image-gallery-wrapper">
      <% if(thisIsWhish == true) { %>
      <a class="wishlist-btn-overlay" href="/RemovePdtFrmWhishlist/<%= produCt._id %>/view">
        <i class="fa-solid fa-heart" style="color: #dd1616; font-size: 20px"></i>
      </a>
      <% } else { %>
      <a class="wishlist-btn-overlay" href="/addToWhishlist/?id=<%= produCt._id %>&from=view">
        <i class="fa-regular fa-heart" style="color: #8f8f8f; font-size: 20px"></i>
      </a>
      <% } %>

      <div class="main-image-viewport">
        <div id="img-container">
          <img src="/productImages/<%= produCt.images[0] %>" id="IMAGE" alt="<%= produCt.name %>" />
        </div>
      </div>

      <div class="thumbnail-list">
        <% produCt.images.forEach((image) => { %>
        <img src="/productImages/<%= image %>" class="thumb-item" onclick="changeImg(this.src)" alt="thumbnail" />
        <% }) %>
      </div>
    </div>

    <div class="product-details-content">
      <span class="brand-tag"><%= produCt.company %></span>
      <h1 class="product-title"><%= produCt.name %></h1>

      <% if (produCt.quantity < 6 && produCt.quantity > 0 ) { %>
      <div class="stock-status-box stock-low"><i class="fa-solid fa-triangle-exclamation"></i> Only <%= produCt.quantity %> units left!</div>
      <% } else if (produCt.quantity < 1) { %>
      <div class="stock-status-box stock-out"><i class="fa-solid fa-circle-xmark"></i> Currently Out of Stock</div>
      <% } %>

      <div class="price-section">
        <% let today = new Date() %> <% if((produCt.product_OfferDetails && produCt.product_OfferDetails.offerStartDate <= today &&
        produCt.product_OfferDetails.offerEndDate >= today) || (produCt.category_OfferDetails && produCt.category_OfferDetails.offerStartDate <= today &&
        produCt.category_OfferDetails.offerEndDate >= today)) { const offer = produCt.product_OfferDetails || produCt.category_OfferDetails; const
        discountAmount = (produCt.price * offer.discountPercentage) / 100; const finalPrice = produCt.price - discountAmount; %>
        <span class="current-price">₹<%= finalPrice.toFixed(2) %></span>
        <span class="strike-price">₹<%= produCt.price %>.00</span>
        <span class="discount-pill"><%= offer.discountPercentage %>% OFF</span>
        <% } else { %>
        <span class="current-price">₹<%= produCt.price %>.00</span>
        <% } %>
      </div>

      <div class="product-description-text">
        <strong>Overview:</strong><br />
        <%= produCt.product_desc %>
      </div>

      <div class="purchase-actions">
        <% if (produCt.quantity < 1) { %>
        <button class="btn-cart" style="background: #ccc; cursor: not-allowed" disabled>COMING SOON</button>
        <% } else { %>
        <a href="/addToCart/?id=<%= produCt._id %>" class="btn-cart"> <i class="fa-solid fa-bag-shopping"></i> &nbsp; ADD TO BAG </a>
        <% } %>
      </div>

      <hr style="margin: 40px 0" />

      <div style="font-size: 14px; color: #777">
        <p><i class="fa-solid fa-truck-fast"></i> &nbsp; Free delivery on orders above ₹999</p>
        <p><i class="fa-solid fa-rotate-left"></i> &nbsp; 30-day easy return policy</p>
      </div>
    </div>
  </div>

  <div class="related-section">
    <h4 class="related-title">You May Also Like</h4>
    <div class="row">
      <% products.forEach((product)=> { %>
      <div class="col-md-3 col-6 mb-4">
        <a href="/viewProduct/?id=<%= product._id %>" style="text-decoration: none; color: inherit">
          <div class="card border-0">
            <img src="/productImages/<%= product.images[0] %>" class="card-img-top rounded-3" style="background: #f1f1f1; height: 250px; object-fit: cover" />
            <div class="card-body px-0">
              <p class="mb-0 text-muted small"><%= product.company %></p>
              <h6 class="mb-1 text-truncate"><%= product.name %></h6>
              <p class="fw-bold">₹<%= product.price %></p>
            </div>
          </div>
        </a>
      </div>
      <% }) %>
    </div>
  </div>
</div>

<%- include('../layouts/footer.ejs') %>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  let zoom1;
  let options1 = {
    width: 450,
    zoomWidth: 400,
    offset: { vertical: 0, horizontal: 15 },
  };

  zoom1 = new ImageZoom(document.getElementById("img-container"), options1);

  async function changeImg(src) {
    let mainIMG = document.getElementById("IMAGE");
    mainIMG.src = src;

    document.getElementById("img-container").innerHTML = `<img src="${src}" id="IMAGE" alt="Product Image">`;
    zoom1 = new ImageZoom(document.getElementById("img-container"), options1);
  }
</script>
